# 如何製作品質優良的patch

## 再次強調：遵守coding style是提交patch最基本該做到的事情
一個專案如果能隨時間成長，用的人越來越多，需求變多，開發人員也就會逐漸增加。專案社群成長，自然使用者回報的bug變多了，關於專案的討論變多了，同時在郵件論壇上提交的patch也會越來越多。有很多開發人員其實是利用個人業餘時間，貢獻進行開放原始碼的專案。大家能空出專門進行開發的時間，可能都不是很多。因此專案能維持一致的coding style是最基本的要求；讓每一個參與者，都能很快讀懂patch，理解這段程式的功能和目的，然後給予建議，最後討論是否要採納。由此可知，為了進行有效率的討論，同時方便納入patch後，日後的維護，patch遵守專案的coding style是再基本不過了。

## 維護人員接受patch的流程
不論提交的patch，是新的功能，或是bug fix；也不論patch大小修改多寡，全部都需要經過維護人員的閱讀審視(review)檢查是否有錯誤，（同時在重複審視的時候，社群的人就會再次檢查是否符合coding style）。一旦patch被接受，維護人員會嘗試將patch合併至原本的程式碼中（通常使用git am），看是否能順利合併。假使這些patch都能順利合併，還需要透過編譯測試、甚至安裝到測試環境上（對u-boot來說，就是將編譯出來的程式，燒錄到開發板上）執行看看。一切都驗證無誤之後，才會正式接受提交上論壇的patch，並且將之透過git push合併到主線（master branch）或是合併到下次release（next branch）之中。

有的時候提交的patch不會只修改一個檔案（譬如.h裡面的#define需要修改或新增，那.c檔的程式通常也要一併修改新增），更多時候社群會收到開發者提交一整組的patch，我們通常稱為patch set。當社群提出修改的要求的時候，就算只修改了一個地方，還是得整組patch set重送；當然如果這組patch之間相依性（dependancy）切得很乾淨，也是有機會部分重送就好，不過這種情況很少。而且如果patch之間相依性很低，那就拆成好幾筆無關的patch分開提交就好了，不用一次全部都上。因此製作品質優良，結構良好，邏輯清楚的patch是很重要的，有助於減少提交patch的開發者修改patch的時間。對專案來說，萬一接受這些patch之後，有產生bug，要追查、退版、安排人力進行bug fix，也就會相對得有效率得多。

## 如何製作好的patch

其實跟coding style一樣，不少專案的說明文件都會附帶製作好的patch的準則。好的patch（或是patch set）不外乎幾個原則：
* 按照寫code的先後邏輯順序組成patch
* patch應該要易於分割重組，力求簡單明瞭
* 相關的patch放一起，無關的patch下次再提交
* patch必須盡可能不要影響其他模組或功能。
* 如果修改到某個通用的介面，要一起修改其他有用到這個介面程式
* patch不應該造成其他模組編譯錯誤，因此送出前最好都要先在local環境確認編譯和執行正確

例如u-boot的wiki上，就有很詳盡的patch製作準則說明：[https://www.denx.de/wiki/U-Boot/Patches](https://www.denx.de/wiki/U-Boot/Patches)，這些準則，通常也適用於Linux和其他的Open Source專案。u-boot的這個wiki頁面，也提到提交Linux的Patch準則：[https://lwn.net/Articles/139918/](https://lwn.net/Articles/139918/)。（必讀）你看，共通概念通常不會差很多，雖然Linux這篇守則完成時間比較早，也非常建議一定要讀過一次。以下針對提交u-boot的patch的準則，挑重點逐條解說。

## 提交u-boot patch的準則

* Release early, release often. 這也是所有open source專案的最重要的準則之一。盡可能早一點release（新版本），盡可能頻繁的release。這樣新功能和新的bug fix才能越快讓使用者受益；如果有新的bug也才能及早發現，及早處理。這個準則對於送patch到專案也是一樣的。有的時候你的patch被拒絕不是因為他不好，可能只是需要跟大家討論，然後需要很多的修改以符合大家的需求。甚至在送出[**PATCH**]之前，就先把你的構想在郵件論壇上先找人討論，會有助於之後你送patch的工作。提出修改的構想，請論壇上的朋友給予意見，這種形式的作法我們通常叫他：[**RFC**]，**Request for Comment**。之後你就可以根據郵件論壇上大家討論的想法，來形成你要提交的patch的架構，以及撰寫的程式流程。

* 所有的patch都必須送到郵件論壇
** 如果你的patch跟某些有固定的維護人員的檔案相關，請在郵件副本加上他們。為了防止後續版本的patch會忘記加上他們到CC:，你也可以在patch的commit message中的簽章之後，加上Cc:。
** 記得加上有回覆你意見的其他人到Cc:，或者前面跟你改過同一個檔案的其他人。他們也會幫忙檢查後續版本的patch是否能符合他們的期待；或者你後來有更好的修改的方法！

* Patches的修改必須是一個完整的邏輯
** 不同且無關的修改必須分開成不同的patch set送出。一個程式功能的修改，只能送出一組patch set。
** 如果一組邏輯的修正包含或者增加了新的檔案，那這些修改必須包在**一個patch**中送出。

上面這兩段白話就是：譬如你寫了兩個個功能，那一個功能就只能包在一組patch set裡面。第二個功能要分開處理。如果有一個功能，新增了一個.h檔，兩個新的.c檔，修改兩個舊的.c檔；那這五個檔案都必須被包在同一個patch裡面送出。這樣可以維持邏輯上的先後順序，並且避免每一筆patch之間的編譯失敗。