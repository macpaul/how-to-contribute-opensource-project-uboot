# 如何製作品質優良的patch

## 再次強調：遵守coding style是提交patch最基本該做到的事情
一個專案如果能隨時間成長，用的人越來越多，需求變多，開發人員也就會逐漸增加。專案社群成長，自然使用者回報的bug變多了，關於專案的討論變多了，同時在郵件論壇上提交的patch也會越來越多。有很多開發人員其實是利用個人業餘時間，貢獻進行開放原始碼的專案。大家能空出專門進行開發的時間，可能都不是很多。因此專案能維持一致的coding style是最基本的要求；讓每一個參與者，都能很快讀懂patch，理解這段程式的功能和目的，然後給予建議，最後討論是否要採納。由此可知，為了進行有效率的討論，同時方便納入patch後，日後的維護，patch遵守專案的coding style是再基本不過了。

## 維護人員接受patch的流程
不論提交的patch，是新的功能，或是bug fix；也不論patch大小修改多寡，全部都需要經過維護人員的閱讀審視(review)檢查是否有錯誤，（同時在重複審視的時候，社群的人就會再次檢查是否符合coding style）。一旦patch被接受，維護人員會嘗試將patch合併至原本的程式碼中（通常使用git am），看是否能順利合併。假使這些patch都能順利合併，還需要透過編譯測試、甚至安裝到測試環境上（對u-boot來說，就是將編譯出來的程式，燒錄到開發板上）執行看看。一切都驗證無誤之後，才會正式接受提交上論壇的patch，並且將之透過git push合併到主線（master branch）或是合併到下次release（next branch）之中。

有的時候提交的patch不會只修改一個檔案（譬如.h裡面的#define需要修改或新增，那.c檔的程式通常也要一併修改新增），更多時候社群會收到開發者提交一整組的patch，我們通常稱為patch set。當社群提出修改的要求的時候，就算只修改了一個地方，還是得整組patch set重送；當然如果這組patch之間相依性（dependancy）切得很乾淨，也是有機會部分重送就好，不過這種情況很少。而且如果patch之間相依性很低，那就拆成好幾筆無關的patch分開提交就好了，不用一次全部都上。因此製作品質優良，結構良好，邏輯清楚的patch是很重要的，有助於減少提交patch的開發者修改patch的時間。對專案來說，萬一接受這些patch之後，有產生bug，要追查、退版、安排人力進行bug fix，也就會相對得有效率得多。

## 如何製作好的patch

其實跟coding style一樣，不少專案的說明文件都會附帶製作好的patch的準則。好的patch（或是patch set）不外乎幾個原則：
1.按照寫code的先後邏輯順序組成patch
2.patch應該要易於分割重組，力求簡單明瞭
3.相關的patch放一起，無關的patch下次再提交
4.patch必須盡可能不要影響其他模組或功能。
5.如果修改到某個通用的介面，要一起修改其他有用到這個介面程式
6.patch不應該造成其他模組編譯錯誤，因此送出前最好都要先在local環境確認編譯和執行正確

例如u-boot的wiki上，就有很詳盡的patch製作準則說明：[https://www.denx.de/wiki/U-Boot/Patches](https://www.denx.de/wiki/U-Boot/Patches)

##